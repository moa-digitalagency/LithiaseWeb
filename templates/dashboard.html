<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de bord - Lithiase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/myoneart.css">
</head>
<body class="page-bg">
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">ğŸ’Š Lithiase</h1>
            <div class="flex items-center space-x-6">
                <a href="/search" class="hover:text-indigo-200 transition-colors font-medium">ğŸ” Recherche avancÃ©e</a>
                <a href="/logout" class="hover:text-indigo-200 transition-colors font-medium">ğŸšª DÃ©connexion</a>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="card bg-gradient-to-br from-blue-50 to-indigo-50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Patients</p>
                        <p id="totalPatients" class="text-3xl font-bold text-indigo-600">0</p>
                    </div>
                    <div class="text-4xl">ğŸ‘¥</div>
                </div>
            </div>
            <div class="card bg-gradient-to-br from-green-50 to-emerald-50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Ã‰pisodes</p>
                        <p id="totalEpisodes" class="text-3xl font-bold text-green-600">0</p>
                    </div>
                    <div class="text-4xl">ğŸ“Š</div>
                </div>
            </div>
            <div class="card bg-gradient-to-br from-purple-50 to-pink-50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">IMC Moyen</p>
                        <p id="avgBMI" class="text-3xl font-bold text-purple-600">-</p>
                    </div>
                    <div class="text-4xl">âš–ï¸</div>
                </div>
            </div>
            <div class="card bg-gradient-to-br from-orange-50 to-red-50">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">DonnÃ©es IA</p>
                        <p id="aiDataCount" class="text-3xl font-bold text-orange-600">0</p>
                    </div>
                    <div class="text-4xl">ğŸ¤–</div>
                </div>
            </div>
        </div>
        
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800">ğŸ‘¥ Patients</h2>
                    <p class="text-gray-600 mt-1">GÃ©rez vos patients et leurs Ã©pisodes de lithiase</p>
                </div>
                <a href="/nouveau-patient" class="btn btn-primary py-3 px-6">
                    â• Nouveau Patient
                </a>
            </div>
            
            <div class="mb-6">
                <input type="text" id="searchInput" placeholder="ğŸ” Rechercher un patient (nom, prÃ©nom, tÃ©lÃ©phone)..."
                    class="input-field"
                    onkeyup="searchPatients()">
            </div>
            
            <div id="patientsList" class="space-y-3">
            </div>
        </div>
    </div>
    
    
    <script>
        async function loadPatients(search = '') {
            const response = await fetch(`/api/patients?search=${search}`);
            const patients = await response.json();
            
            updateStatistics(patients);
            
            const container = document.getElementById('patientsList');
            
            if (patients.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">ğŸ˜” Aucun patient trouvÃ©</p>';
                return;
            }
            
            container.innerHTML = patients.map(p => `
                <div class="patient-card"
                     onclick="window.location.href='/patient/${p.id}'">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">ğŸ‘¤ ${p.nom} ${p.prenom}</h3>
                            <p class="text-gray-600 text-sm mt-1">ğŸ“… NÃ©(e) le ${new Date(p.date_naissance).toLocaleDateString('fr-FR')}</p>
                            <p class="text-gray-600 text-sm">ğŸ“ ${p.telephone || 'TÃ©lÃ©phone non renseignÃ©'}</p>
                        </div>
                        <div class="text-right">
                            <span class="badge badge-info">
                                ğŸ“Š ${p.nb_episodes} Ã©pisode(s)
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function updateStatistics(patients) {
            document.getElementById('totalPatients').textContent = patients.length;
            
            const totalEpisodes = patients.reduce((sum, p) => sum + (p.nb_episodes || 0), 0);
            document.getElementById('totalEpisodes').textContent = totalEpisodes;
            
            const patientsWithBMI = await Promise.all(
                patients.map(async p => {
                    const detailResponse = await fetch(`/api/patients/${p.id}`);
                    return detailResponse.json();
                })
            );
            
            const validBMIs = patientsWithBMI
                .filter(p => p.poids && p.taille)
                .map(p => p.poids / Math.pow(p.taille / 100, 2));
            
            if (validBMIs.length > 0) {
                const avgBMI = validBMIs.reduce((a, b) => a + b, 0) / validBMIs.length;
                document.getElementById('avgBMI').textContent = avgBMI.toFixed(1);
            } else {
                document.getElementById('avgBMI').textContent = '-';
            }
            
            const aiReadyCount = patientsWithBMI.filter(p => 
                p.poids && p.taille && (p.petit_dejeuner || p.dejeuner || p.diner)
            ).length;
            document.getElementById('aiDataCount').textContent = aiReadyCount;
        }
        
        function searchPatients() {
            const search = document.getElementById('searchInput').value;
            loadPatients(search);
        }
        
        loadPatients();
    </script>
</body>
</html>
