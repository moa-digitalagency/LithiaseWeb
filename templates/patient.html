<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiche Patient - Lithiase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/mysindic.css">
</head>
<body class="page-bg">
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">üíä Lithiase</h1>
            <div class="flex items-center space-x-6">
                <a href="/" class="hover:text-indigo-200 transition-colors font-medium">üè† Tableau de bord</a>
                <a href="/search" class="hover:text-indigo-200 transition-colors font-medium">üîç Recherche</a>
                <a href="/logout" class="hover:text-indigo-200 transition-colors font-medium">üö™ D√©connexion</a>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6">
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 id="patientName" class="text-3xl font-bold text-gray-800"></h2>
                    <div id="patientInfo" class="grid grid-cols-2 gap-3 mt-4 text-gray-700"></div>
                </div>
                <button onclick="exportPDF()" class="btn btn-success py-3 px-6">
                    üìÑ Exporter PDF
                </button>
            </div>
        </div>
        
        <div class="card mb-6">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">üìä √âpisodes</h3>
                    <p class="text-gray-600 mt-1">Historique des √©pisodes lithiasiques</p>
                </div>
                <button onclick="showNewEpisodeModal()" class="btn btn-primary py-2 px-4">
                    ‚ûï Nouvel √âpisode
                </button>
            </div>
            <div id="episodesList" class="space-y-4"></div>
        </div>
    </div>
    
    <div id="newEpisodeModal" class="hidden modal-backdrop">
        <div class="modal-content modal-md my-8 mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-2xl font-bold text-gray-800">‚ûï Nouvel √âpisode</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="newEpisodeForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ Date *</label>
                            <input type="date" name="date_episode" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üìù Motif</label>
                            <input type="text" name="motif" class="input-field">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ü©∫ Diagnostic</label>
                        <input type="text" name="diagnostic" class="input-field">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex items-center">
                            <input type="checkbox" name="douleur" id="douleur" class="mr-2">
                            <label for="douleur">üò£ Douleur</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="fievre" id="fievre" class="mr-2">
                            <label for="fievre">üå°Ô∏è Fi√®vre</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" name="infection_urinaire" id="infection" class="mr-2">
                            <label for="infection">ü¶† Infection urinaire</label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideNewEpisodeModal()" class="btn btn-secondary">Annuler</button>
                        <button type="submit" class="btn btn-primary">Cr√©er</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="episodeDetailModal" class="hidden modal-backdrop">
        <div class="modal-content modal-lg my-8 mx-4">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">üìã D√©tails de l'√©pisode</h3>
                <button onclick="hideEpisodeDetailModal()" class="btn btn-secondary btn-close">‚úï</button>
            </div>
            <div class="p-6 max-h-[80vh] overflow-y-auto">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-4">üî¨ Imagerie</h4>
                        <button onclick="showNewImagingModal()" class="btn btn-primary mb-4">‚ûï Ajouter Imagerie</button>
                        <div id="imagingList" class="space-y-3"></div>
                    </div>
                    
                    <div>
                        <h4 class="text-xl font-bold text-gray-800 mb-4">üß™ Biologie</h4>
                        <button onclick="showNewBiologyModal()" class="btn btn-primary mb-4">‚ûï Ajouter Biologie</button>
                        <div id="biologyList" class="space-y-3"></div>
                    </div>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200">
                    <button onclick="runInference()" class="btn btn-purple py-3 px-6 text-base">
                        ü§ñ Calculer le type de calcul
                    </button>
                    <div id="inferenceResult" class="mt-4"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="newImagingModal" class="hidden modal-backdrop">
        <div class="modal-content modal-sm my-8 mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üî¨ Nouvelle Imagerie (Scanner)</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="newImagingForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">üìÖ Date examen *</label>
                            <input type="date" name="date_examen" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">üìè Taille (mm)</label>
                            <input type="number" name="taille_mm" min="0" class="input-field">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">‚ö° Densit√© (UH)</label>
                            <input type="number" name="densite_uh" min="100" max="2200" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">üîç Morphologie</label>
                            <select name="morphologie" class="input-field">
                                <option value="">-- S√©lectionner --</option>
                                <option value="spherique_lisse">Sph√©rique lisse</option>
                                <option value="irreguliere_spiculee">Irr√©guli√®re spicul√©e</option>
                                <option value="crayeuse">Crayeuse</option>
                                <option value="coralliforme">Coralliforme</option>
                                <option value="heterogene">H√©t√©rog√®ne</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">üì° Radio-opacit√©</label>
                            <select name="radio_opacite" class="input-field">
                                <option value="">-- S√©lectionner --</option>
                                <option value="opaque">Opaque</option>
                                <option value="transparent">Transparent</option>
                                <option value="inconnu">Inconnu</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">üìç Localisation</label>
                            <input type="text" name="localisation" placeholder="Ex: Rein gauche, calice sup√©rieur" class="input-field">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideNewImagingModal()" class="btn btn-secondary">Annuler</button>
                        <button type="submit" class="btn btn-primary">Cr√©er</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div id="newBiologyModal" class="hidden modal-backdrop">
        <div class="modal-content modal-sm my-8 mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 class="text-xl font-bold text-gray-800">üß™ Nouvelle Biologie</h3>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <form id="newBiologyForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">üìÖ Date examen *</label>
                            <input type="date" name="date_examen" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">üß™ pH urinaire (4.5-8.5)</label>
                            <input type="number" name="ph_urinaire" step="0.1" min="4.5" max="8.5" class="input-field">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">üìä Marqueurs m√©taboliques</label>
                        <div class="grid grid-cols-2 gap-2">
                            <div class="flex items-center">
                                <input type="checkbox" name="hyperoxalurie" id="hyperoxalurie" class="mr-2">
                                <label for="hyperoxalurie">Hyperoxalurie</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="hypercalciurie" id="hypercalciurie" class="mr-2">
                                <label for="hypercalciurie">Hypercalciurie</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="hyperuricurie" id="hyperuricurie" class="mr-2">
                                <label for="hyperuricurie">Hyperuricurie</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="cystinurie" id="cystinurie" class="mr-2">
                                <label for="cystinurie">Cystinurie</label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" name="infection_urinaire" id="bio_infection" class="mr-2">
                        <label for="bio_infection">ü¶† Infection urinaire</label>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideNewBiologyModal()" class="btn btn-secondary">Annuler</button>
                        <button type="submit" class="btn btn-primary">Cr√©er</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script>
        const patientId = {{ patient_id }};
        let currentEpisodeId = null;
        
        async function loadPatient() {
            const response = await fetch(`/api/patients/${patientId}`);
            const patient = await response.json();
            
            document.getElementById('patientName').textContent = `üë§ ${patient.nom} ${patient.prenom}`;
            document.getElementById('patientInfo').innerHTML = `
                <div class="info-card"><strong>üìÖ Date de naissance:</strong> ${new Date(patient.date_naissance).toLocaleDateString('fr-FR')}</div>
                <div class="info-card"><strong>‚öß Sexe:</strong> ${patient.sexe === 'M' ? 'Masculin' : 'F√©minin'}</div>
                <div class="info-card"><strong>üìû T√©l√©phone:</strong> ${patient.telephone || '-'}</div>
                <div class="info-card"><strong>üìß Email:</strong> ${patient.email || '-'}</div>
            `;
            
            loadEpisodes();
        }
        
        async function loadEpisodes() {
            const response = await fetch(`/api/patients/${patientId}/episodes`);
            const episodes = await response.json();
            
            const container = document.getElementById('episodesList');
            
            if (episodes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">üòî Aucun √©pisode enregistr√©</p>';
                return;
            }
            
            container.innerHTML = episodes.map(e => `
                <div class="episode-card" onclick="showEpisodeDetail(${e.id})">
                    <div class="flex justify-between">
                        <div>
                            <h4 class="font-semibold text-lg text-gray-800">üìã ${e.motif || '√âpisode'}</h4>
                            <p class="text-gray-600 text-sm mt-1">üìÖ ${new Date(e.date_episode).toLocaleDateString('fr-FR')}</p>
                            <p class="text-gray-700 text-sm mt-1">${e.diagnostic || ''}</p>
                        </div>
                        <div class="flex flex-col gap-2 text-sm">
                            <span class="badge badge-info">üî¨ ${e.nb_imageries} imagerie(s)</span>
                            <span class="badge badge-success">üß™ ${e.nb_biologies} biologie(s)</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        async function showEpisodeDetail(episodeId) {
            currentEpisodeId = episodeId;
            const response = await fetch(`/api/episodes/${episodeId}`);
            const episode = await response.json();
            
            document.getElementById('imagingList').innerHTML = episode.imageries.map(i => `
                <div class="info-card">
                    <div><strong>üìÖ Date:</strong> ${new Date(i.date_examen).toLocaleDateString('fr-FR')}</div>
                    <div><strong>üìè Taille:</strong> ${i.taille_mm || '-'} mm</div>
                    <div><strong>‚ö° Densit√©:</strong> ${i.densite_uh || '-'} UH</div>
                    <div><strong>üîç Morphologie:</strong> ${i.morphologie || '-'}</div>
                </div>
            `).join('') || '<p class="text-gray-500">üòî Aucune imagerie</p>';
            
            document.getElementById('biologyList').innerHTML = episode.biologies.map(b => `
                <div class="info-card">
                    <div><strong>üìÖ Date:</strong> ${new Date(b.date_examen).toLocaleDateString('fr-FR')}</div>
                    <div><strong>üß™ pH:</strong> ${b.ph_urinaire || '-'}</div>
                    <div><strong>Hyperoxalurie:</strong> ${b.hyperoxalurie ? '‚úÖ Oui' : '‚ùå Non'}</div>
                    <div><strong>Hypercalciurie:</strong> ${b.hypercalciurie ? '‚úÖ Oui' : '‚ùå Non'}</div>
                </div>
            `).join('') || '<p class="text-gray-500">üòî Aucune biologie</p>';
            
            document.getElementById('episodeDetailModal').classList.remove('hidden');
        }
        
        async function runInference() {
            const response = await fetch(`/api/episodes/${currentEpisodeId}/inference`, {
                method: 'POST'
            });
            const result = await response.json();
            
            if (result.error) {
                document.getElementById('inferenceResult').innerHTML = `<div style="background: rgba(239, 68, 68, 0.08); border: 2px solid #EF4444; color: #991B1B; padding: 1rem; border-radius: 1rem;">‚ùå ${result.error}</div>`;
                return;
            }
            
            document.getElementById('inferenceResult').innerHTML = `
                <div style="border: 2px dashed #8B5CF6; background: rgba(139, 92, 246, 0.08); border-radius: 1.5rem; padding: 2rem;">
                    <h4 class="text-2xl font-bold mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ü§ñ R√©sultat de l'inf√©rence</h4>
                    
                    ${result.uncertain ? '<div style="background: rgba(245, 158, 11, 0.08); border: 2px solid #F59E0B; color: #92400E; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 1rem;">‚ö†Ô∏è R√©sultat incertain, compl√©ter biologie/CT</div>' : ''}
                    
                    <div class="mb-4">
                        <h5 class="font-bold text-lg mb-2">üéØ Type propos√©: ${result.top_1}</h5>
                        <p class="text-gray-700">‚≠ê Score: ${result.top_1_score}/20</p>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="font-semibold mb-2">üìù Justification:</h5>
                        <ul class="list-disc list-inside space-y-1">
                            ${result.top_1_reasons.map(r => `<li class="text-gray-700">${r}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div class="mb-4">
                        <h5 class="font-semibold mb-2">üìä Top 3:</h5>
                        ${result.top_3.map(([type, score]) => `<div class="flex justify-between py-1 px-2 bg-white rounded"><span>${type}</span><span class="font-mono font-bold">${score}/20</span></div>`).join('')}
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-white p-3 rounded-lg">
                            <strong>‚ö° LEC √©ligible:</strong> <span class="font-semibold ${result.lec_eligible ? 'text-green-600' : 'text-red-600'}">${result.lec_eligible ? '‚úÖ Oui' : '‚ùå Non'}</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg">
                            <strong>üî¨ Voie de traitement:</strong> ${result.voie_traitement}
                        </div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg">
                        <h5 class="font-semibold mb-2">üõ°Ô∏è Pr√©vention:</h5>
                        <ul class="list-disc list-inside space-y-1">
                            ${result.prevention.map(p => `<li class="text-gray-700">${p}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function showNewEpisodeModal() {
            document.getElementById('newEpisodeModal').classList.remove('hidden');
        }
        
        function hideNewEpisodeModal() {
            document.getElementById('newEpisodeModal').classList.add('hidden');
        }
        
        function hideEpisodeDetailModal() {
            document.getElementById('episodeDetailModal').classList.add('hidden');
            document.getElementById('inferenceResult').innerHTML = '';
        }
        
        function showNewImagingModal() {
            document.getElementById('newImagingModal').classList.remove('hidden');
        }
        
        function hideNewImagingModal() {
            document.getElementById('newImagingModal').classList.add('hidden');
        }
        
        function showNewBiologyModal() {
            document.getElementById('newBiologyModal').classList.remove('hidden');
        }
        
        function hideNewBiologyModal() {
            document.getElementById('newBiologyModal').classList.add('hidden');
        }
        
        async function exportPDF() {
            window.open(`/api/patients/${patientId}/export/pdf`, '_blank');
        }
        
        ['newEpisodeModal', 'episodeDetailModal', 'newImagingModal', 'newBiologyModal'].forEach(modalId => {
            document.getElementById(modalId).addEventListener('click', (e) => {
                if (e.target.id === modalId) {
                    document.getElementById(modalId).classList.add('hidden');
                }
            });
        });
        
        document.getElementById('newEpisodeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.douleur = formData.has('douleur');
            data.fievre = formData.has('fievre');
            data.infection_urinaire = formData.has('infection_urinaire');
            
            await fetch(`/api/patients/${patientId}/episodes`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            hideNewEpisodeModal();
            loadEpisodes();
        });
        
        document.getElementById('newImagingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            await fetch(`/api/episodes/${currentEpisodeId}/imageries`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            hideNewImagingModal();
            showEpisodeDetail(currentEpisodeId);
        });
        
        document.getElementById('newBiologyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            data.hyperoxalurie = formData.has('hyperoxalurie');
            data.hypercalciurie = formData.has('hypercalciurie');
            data.hyperuricurie = formData.has('hyperuricurie');
            data.cystinurie = formData.has('cystinurie');
            data.infection_urinaire = formData.has('infection_urinaire');
            
            await fetch(`/api/episodes/${currentEpisodeId}/biologies`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            hideNewBiologyModal();
            showEpisodeDetail(currentEpisodeId);
        });
        
        loadPatient();
    </script>
</body>
</html>
