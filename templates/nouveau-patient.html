<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouveau Patient - Lithiase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/myoneart.css">
</head>
<body class="page-bg">
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">ğŸ’Š Lithiase</h1>
            <div class="flex items-center space-x-6">
                <a href="/" class="hover:text-indigo-200 transition-colors font-medium">ğŸ  Tableau de bord</a>
                <a href="/search" class="hover:text-indigo-200 transition-colors font-medium">ğŸ” Recherche avancÃ©e</a>
                <a href="/logout" class="hover:text-indigo-200 transition-colors font-medium">ğŸšª DÃ©connexion</a>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6 max-w-7xl">
        <div class="card">
            <div class="border-b border-gray-200 pb-4 mb-6">
                <h2 class="text-3xl font-bold text-gray-800">â• Nouveau Patient</h2>
                <p class="text-gray-600 mt-2">Formulaire complet pour enregistrer un nouveau patient avec analyse morpho-constitutionnelle</p>
            </div>
            
            <!-- Section: Objectifs de l'analyse -->
            <div class="bg-gradient-to-r from-indigo-100 to-purple-100 border-2 border-indigo-300 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-indigo-900 mb-3 flex items-center">
                    <span class="text-2xl mr-2">ğŸ¯</span> Objectifs de l'analyse
                </h3>
                <ul class="space-y-2 text-sm text-gray-800">
                    <li class="flex items-start">
                        <span class="text-indigo-600 mr-2">âœ“</span>
                        <span>DÃ©terminer la <strong>nature morpho-constitutionnelle</strong> du calcul selon la classification de Daudon</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-indigo-600 mr-2">âœ“</span>
                        <span>DÃ©tecter les <strong>anomalies dans les habitudes</strong> du patient favorisant la formation des calculs</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-indigo-600 mr-2">âœ“</span>
                        <span>Proposer un <strong>rÃ©gime alimentaire adaptÃ©</strong> pour prÃ©venir les rÃ©cidives</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-indigo-600 mr-2">âœ“</span>
                        <span>Recommander un <strong>traitement mÃ©dical</strong> fondÃ© sur les derniÃ¨res donnÃ©es scientifiques</span>
                    </li>
                    <li class="flex items-start">
                        <span class="text-indigo-600 mr-2">âœ“</span>
                        <span>En cas d'infection urinaire associÃ©e : proposer un traitement adaptÃ© selon la <strong>nature du germe</strong> isolÃ©</span>
                    </li>
                </ul>
            </div>
            
            <form id="newPatientForm" class="space-y-8">
                <!-- Section: Informations personnelles -->
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ‘¤</span> Informations personnelles
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                            <input type="text" name="nom" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">PrÃ©nom *</label>
                            <input type="text" name="prenom" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date de naissance *</label>
                            <input type="date" name="date_naissance" required class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Sexe *</label>
                            <select name="sexe" required class="input-field">
                                <option value="M">Masculin</option>
                                <option value="F">FÃ©minin</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ Groupe ethnique</label>
                            <input type="text" name="groupe_ethnique" class="input-field" placeholder="Ex: Caucasien, Africain, Asiatique...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ TÃ©lÃ©phone</label>
                            <input type="tel" name="telephone" class="input-field">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“§ Email</label>
                            <input type="email" name="email" class="input-field">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Adresse</label>
                            <textarea name="adresse" rows="2" class="input-field"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section: AnthropomÃ©trie -->
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-green-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">âš–ï¸</span> AnthropomÃ©trie
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">âš–ï¸ Poids (kg)</label>
                            <input type="number" step="0.1" name="poids" id="poids" class="input-field" placeholder="Ex: 75.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ Taille (cm)</label>
                            <input type="number" step="0.1" name="taille" id="taille" class="input-field" placeholder="Ex: 175">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“Š IMC (calculÃ© automatiquement)</label>
                            <input type="text" id="imc" class="input-field bg-gray-100" readonly placeholder="--">
                        </div>
                    </div>
                </div>

                <!-- Section: AntÃ©cÃ©dents mÃ©dicaux -->
                <div class="bg-red-50 border-2 border-red-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-red-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ¥</span> AntÃ©cÃ©dents mÃ©dicaux
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“‹ AntÃ©cÃ©dents personnels (Uro, mÃ©taboliques, endocrino...)</label>
                            <textarea name="antecedents_personnels" rows="3" class="input-field" placeholder="DÃ©crivez les antÃ©cÃ©dents urologiques, mÃ©taboliques, endocriniens..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ AntÃ©cÃ©dents familiaux (lithiase)</label>
                            <textarea name="antecedents_familiaux" rows="2" class="input-field" placeholder="Historique familial de lithiase..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¥ AntÃ©cÃ©dents chirurgicaux</label>
                            <textarea name="antecedents_chirurgicaux" rows="2" class="input-field" placeholder="Chirurgies antÃ©rieures..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">âš ï¸ Allergies</label>
                            <textarea name="allergies" rows="2" class="input-field" placeholder="Allergies mÃ©dicamenteuses ou autres..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’Š Traitements en cours (liste + posologies)</label>
                            <textarea name="traitements_chroniques" rows="3" class="input-field" placeholder="MÃ©dicaments pris rÃ©guliÃ¨rement avec posologies..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section: Habitudes alimentaires -->
                <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-yellow-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ½ï¸</span> Habitudes alimentaires
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’§ Hydratation quotidienne (L/jour)</label>
                            <input type="number" step="0.1" name="hydratation_jour" class="input-field" placeholder="Ex: 2.5">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ´ RÃ©gime alimentaire gÃ©nÃ©ral</label>
                            <textarea name="regime_alimentaire" rows="2" class="input-field" placeholder="RÃ©gime riche en protÃ©ines/sel/oxalate... PrÃ©cisez les caractÃ©ristiques gÃ©nÃ©rales"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ… Petit dÃ©jeuner</label>
                                <textarea name="petit_dejeuner" rows="3" class="input-field" placeholder="Types d'aliments consommÃ©s au petit dÃ©jeuner..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">â˜€ï¸ DÃ©jeuner</label>
                                <textarea name="dejeuner" rows="3" class="input-field" placeholder="Types d'aliments consommÃ©s au dÃ©jeuner..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸŒ™ DÃ®ner</label>
                                <textarea name="diner" rows="3" class="input-field" placeholder="Types d'aliments consommÃ©s au dÃ®ner..."></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸª Grignotage & goÃ»ters</label>
                                <textarea name="grignotage" rows="3" class="input-field" placeholder="Grignotages, goÃ»ters, encas..."></textarea>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ· Autres consommations (apÃ©ritifs, boissons...)</label>
                            <textarea name="autres_consommations" rows="2" class="input-field" placeholder="ApÃ©ritifs, boissons spÃ©cifiques, autres consommations..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Section: Imagerie mÃ©dicale -->
                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-purple-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ”¬</span> Imagerie mÃ©dicale
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“‹ ASP (Abdomen Sans PrÃ©paration)</label>
                            <textarea name="asp_resultats" rows="3" class="input-field" placeholder="RÃ©sultats de la radiographie standard (ASP)..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”Š Ã‰chographie</label>
                            <textarea name="echographie_resultats" rows="3" class="input-field" placeholder="RÃ©sultats de l'Ã©chographie..."></textarea>
                        </div>
                        
                        <!-- Uro-scanner avec dÃ©tails des calculs intÃ©grÃ©s -->
                        <div class="border-l-4 border-purple-400 pl-4">
                            <h4 class="text-lg font-semibold text-purple-800 mb-3 flex items-center">
                                <span class="text-xl mr-2">ğŸ’»</span> Uro-scanner & dÃ©tails des calculs rÃ©naux
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ RÃ©sultats gÃ©nÃ©raux de l'uro-scanner</label>
                                    <textarea name="uroscanner_resultats" rows="3" class="input-field" placeholder="RÃ©sultats de l'uro-scanner..."></textarea>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”¢ Nombre de calculs</label>
                                        <input type="number" name="nombre_calculs" class="input-field" placeholder="Ex: 2">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ—ºï¸ Topographie du calcul</label>
                                        <input type="text" name="topographie_calcul" class="input-field" placeholder="Ex: Rein droit, calice infÃ©rieur, uretÃ¨re...">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ DiamÃ¨tre longitudinal (mm)</label>
                                        <input type="number" step="0.1" name="diametre_longitudinal" class="input-field" placeholder="Ex: 12.5">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ DiamÃ¨tre transversal (mm)</label>
                                        <input type="number" step="0.1" name="diametre_transversal" class="input-field" placeholder="Ex: 8.3">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”¶ Forme du calcul</label>
                                        <input type="text" name="forme_calcul" class="input-field" placeholder="Ex: Rond, ovale, irrÃ©gulier, coralliforme...">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">â­• Contour du calcul</label>
                                        <input type="text" name="contour_calcul" class="input-field" placeholder="Ex: RÃ©gulier, irrÃ©gulier, lisse, spiculÃ©...">
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’  DensitÃ© du noyau (UH)</label>
                                        <input type="number" name="densite_noyau" class="input-field" placeholder="Ex: 800">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¨ DensitÃ©s des diffÃ©rentes couches</label>
                                        <input type="text" name="densites_couches" class="input-field" placeholder="Ex: Noyau 800 UH, couche 1: 650 UH...">
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ©º Autres calcifications (paroi vasculaire, ganglions, score calcique...)</label>
                                    <textarea name="calcifications_autres" rows="2" class="input-field" placeholder="DÃ©crivez les autres calcifications observÃ©es..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- PiÃ¨ce jointe imagerie (Ã  implÃ©menter) -->
                        <!-- <div class="mt-4 pt-4 border-t border-purple-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ PiÃ¨ce jointe : RÃ©sultats d'imagerie (facultatif)</label>
                            <input type="file" name="fichier_imagerie" accept="image/*,.pdf" class="input-field">
                            <p class="text-xs text-gray-500 mt-1">Formats acceptÃ©s : JPG, PNG, PDF (Max 10 Mo)</p>
                        </div> -->
                    </div>
                </div>

                <!-- Section: RÃ©sultats de laboratoire -->
                <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-teal-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ§ª</span> RÃ©sultats de laboratoire
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ”¬ SÃ©diment urinaire</label>
                            <textarea name="sediment_urinaire" rows="2" class="input-field" placeholder="RÃ©sultats du sÃ©diment urinaire..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ¦  ECBU (Examen CytobactÃ©riologique Urinaire)</label>
                            <textarea name="ecbu_resultats" rows="2" class="input-field" placeholder="RÃ©sultats de l'ECBU (germe isolÃ© si infection)..."></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">âš—ï¸ pH urinaire</label>
                                <input type="number" step="0.1" name="ph_urinaire" class="input-field" placeholder="Ex: 6.5">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ’§ DensitÃ© urinaire</label>
                                <input type="number" step="0.001" name="densite_urinaire" class="input-field" placeholder="Ex: 1.020">
                            </div>
                        </div>
                        
                        <!-- PiÃ¨ce jointe laboratoire (Ã  implÃ©menter) -->
                        <!-- <div class="mt-4 pt-4 border-t border-teal-200">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ PiÃ¨ce jointe : RÃ©sultats de laboratoire (facultatif)</label>
                            <input type="file" name="fichier_laboratoire" accept="image/*,.pdf" class="input-field">
                            <p class="text-xs text-gray-500 mt-1">Formats acceptÃ©s : JPG, PNG, PDF (Max 10 Mo)</p>
                        </div> -->
                    </div>
                </div>

                <!-- Section: Ordonnances & documents (Ã  implÃ©menter) -->
                <!-- <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ“„</span> Ordonnances & documents antÃ©rieurs
                    </h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“ PiÃ¨ce jointe : Ordonnance antÃ©rieure (facultatif)</label>
                        <input type="file" name="fichier_ordonnance" accept="image/*,.pdf" class="input-field">
                        <p class="text-xs text-gray-500 mt-1">Formats acceptÃ©s : JPG, PNG, PDF (Max 10 Mo)</p>
                    </div>
                </div> -->

                <!-- Section: Notes -->
                <div class="bg-gray-50 border-2 border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <span class="text-2xl mr-2">ğŸ“</span> Notes complÃ©mentaires
                    </h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes libres</label>
                        <textarea name="notes" rows="4" class="input-field" placeholder="Informations complÃ©mentaires, observations particuliÃ¨res..."></textarea>
                    </div>
                </div>

                <!-- Boutons d'action -->
                <div class="flex justify-end space-x-4 pt-4 border-t border-gray-200">
                    <a href="/" class="btn btn-secondary">
                        Annuler
                    </a>
                    <button type="submit" class="btn btn-primary">
                        âœ“ CrÃ©er le patient
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Calcul automatique de l'IMC
        function calculerIMC() {
            const poids = parseFloat(document.getElementById('poids').value);
            const taille = parseFloat(document.getElementById('taille').value);
            const imcField = document.getElementById('imc');
            
            if (poids > 0 && taille > 0) {
                const tailleMetres = taille / 100;
                const imc = (poids / (tailleMetres * tailleMetres)).toFixed(1);
                imcField.value = imc + ' kg/mÂ²';
                
                // Classification IMC avec couleurs
                if (imc < 18.5) {
                    imcField.className = 'input-field bg-blue-100 text-blue-800 font-semibold';
                } else if (imc < 25) {
                    imcField.className = 'input-field bg-green-100 text-green-800 font-semibold';
                } else if (imc < 30) {
                    imcField.className = 'input-field bg-yellow-100 text-yellow-800 font-semibold';
                } else {
                    imcField.className = 'input-field bg-red-100 text-red-800 font-semibold';
                }
            } else {
                imcField.value = '--';
                imcField.className = 'input-field bg-gray-100';
            }
        }
        
        document.getElementById('poids').addEventListener('input', calculerIMC);
        document.getElementById('taille').addEventListener('input', calculerIMC);
        
        // Soumission du formulaire
        document.getElementById('newPatientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {};
            
            // Convertir FormData en objet JSON (sauf fichiers)
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    // TODO: Upload de fichiers Ã  implÃ©menter
                    continue;
                }
                if (value !== '') {
                    data[key] = value;
                }
            }
            
            try {
                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert('âœ“ Patient crÃ©Ã© avec succÃ¨s!');
                    window.location.href = '/patient/' + result.id;
                } else {
                    const error = await response.json();
                    alert('âŒ Erreur lors de la crÃ©ation du patient: ' + (error.error || 'Erreur inconnue'));
                }
            } catch (error) {
                alert('âŒ Erreur de connexion au serveur');
                console.error('Error:', error);
            }
        });
    </script>
</body>
</html>
