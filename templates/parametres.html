<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Param√®tres - Algorithme Lithiase KALONJI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/css/myoneart.css">
</head>
<body class="page-bg">
    <nav class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">üíé KALONJI</h1>
            <div class="flex items-center space-x-6">
                <a href="/dashboard" class="hover:text-indigo-200 transition-colors font-medium">üè† Tableau de bord</a>
                <a href="/nouveau-patient" class="hover:text-indigo-200 transition-colors font-medium">‚ûï Nouveau Patient</a>
                <a href="/liste-patients" class="hover:text-indigo-200 transition-colors font-medium">üìã Liste patients</a>
                <a href="/search" class="hover:text-indigo-200 transition-colors font-medium">üîç Recherche avanc√©e</a>
                <a href="/parametres" class="hover:text-indigo-200 transition-colors font-medium">‚öôÔ∏è Param√®tres</a>
                <a href="/logout" class="hover:text-indigo-200 transition-colors font-medium">üö™ D√©connexion</a>
            </div>
        </div>
    </nav>
    
    <div class="container mx-auto p-6 max-w-4xl">
        <div class="card mb-6">
            <div class="border-b border-gray-200 pb-4 mb-6">
                <h2 class="text-3xl font-bold text-gray-800">‚öôÔ∏è Param√®tres</h2>
                <p class="text-gray-600 mt-2">G√©rez vos pr√©f√©rences et param√®tres de compte</p>
            </div>
            
            <div class="space-y-8">
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-blue-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üë§</span> Profil utilisateur
                    </h3>
                    
                    <form id="profileForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur</label>
                            <input type="text" id="username" name="username" class="input-field" required>
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">
                                üíæ Sauvegarder le profil
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-purple-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üîí</span> S√©curit√©
                    </h3>
                    
                    <form id="passwordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe actuel *</label>
                            <input type="password" name="current_password" required class="input-field">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nouveau mot de passe *</label>
                            <input type="password" name="new_password" required class="input-field" minlength="6">
                            <p class="text-xs text-gray-500 mt-1">Minimum 6 caract√®res</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le nouveau mot de passe *</label>
                            <input type="password" name="confirm_password" required class="input-field" minlength="6">
                        </div>
                        
                        <div class="flex justify-end">
                            <button type="submit" class="btn btn-primary">
                                üîë Changer le mot de passe
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="userManagementSection" class="bg-indigo-50 border-2 border-indigo-200 rounded-lg p-6 hidden">
                    <h3 class="text-xl font-bold text-indigo-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üë•</span> Gestion des utilisateurs
                    </h3>
                    
                    <div class="mb-4">
                        <button onclick="showAddUserModal()" class="btn btn-primary">
                            ‚ûï Ajouter un utilisateur
                        </button>
                    </div>
                    
                    <div id="usersList" class="space-y-3">
                    </div>
                </div>
                
                <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-green-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">üîê</span> S√©curit√© des donn√©es
                    </h3>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-white rounded">
                            <div>
                                <p class="font-medium text-gray-800">Chiffrement des donn√©es patients</p>
                                <p class="text-sm text-gray-600">Toutes les donn√©es sensibles sont chiffr√©es</p>
                            </div>
                            <div class="flex items-center">
                                <span id="encryptionStatus" class="badge badge-success">‚úì Actif</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-white rounded">
                            <div>
                                <p class="font-medium text-gray-800">Base de donn√©es</p>
                                <p class="text-sm text-gray-600">PostgreSQL avec chiffrement AES-128</p>
                            </div>
                            <div class="flex items-center">
                                <span class="badge badge-info">‚ÑπÔ∏è PostgreSQL</span>
                            </div>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-white rounded">
                            <div>
                                <p class="font-medium text-gray-800">Conformit√© RGPD</p>
                                <p class="text-sm text-gray-600">Donn√©es m√©dicales prot√©g√©es selon RGPD</p>
                            </div>
                            <div class="flex items-center">
                                <span class="badge badge-success">‚úì Conforme</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-orange-900 mb-4 flex items-center">
                        <span class="text-2xl mr-2">‚ÑπÔ∏è</span> Informations syst√®me
                    </h3>
                    
                    <div class="space-y-2 text-sm text-gray-700">
                        <div class="flex justify-between p-2 bg-white rounded">
                            <span class="font-medium">Version de l'application</span>
                            <span>1.0.0</span>
                        </div>
                        <div class="flex justify-between p-2 bg-white rounded">
                            <span class="font-medium">Framework</span>
                            <span>Flask 3.0.0</span>
                        </div>
                        <div class="flex justify-between p-2 bg-white rounded">
                            <span class="font-medium">Base de donn√©es</span>
                            <span>PostgreSQL</span>
                        </div>
                        <div class="flex justify-between p-2 bg-white rounded">
                            <span class="font-medium">Type de d√©ploiement</span>
                            <span>D√©veloppement</span>
                        </div>
                    </div>
                </div>
                
                <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-yellow-900 mb-3 flex items-center">
                        <span class="text-2xl mr-2">‚ö†Ô∏è</span> Zone de danger
                    </h3>
                    <p class="text-sm text-gray-700 mb-4">
                        Les actions suivantes sont irr√©versibles. Veuillez proc√©der avec prudence.
                    </p>
                    
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-yellow-300">
                            <div>
                                <p class="font-medium text-gray-800">Sauvegarde de la base de donn√©es</p>
                                <p class="text-sm text-gray-600">Cr√©er une copie de sauvegarde compl√®te</p>
                            </div>
                            <button class="btn btn-warning" onclick="backupDatabase()">
                                üíæ Sauvegarder
                            </button>
                        </div>
                        
                        <div class="flex items-center justify-between p-3 bg-white rounded border border-red-300">
                            <div>
                                <p class="font-medium text-red-700">Exporter toutes les donn√©es</p>
                                <p class="text-sm text-gray-600">Exporter toutes les donn√©es en format JSON</p>
                            </div>
                            <button class="btn btn-secondary" onclick="exportAllData()">
                                üì§ Exporter
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="userModal" class="hidden modal-backdrop">
        <div class="modal-content modal-md my-8 mx-4">
            <div class="p-6 border-b border-gray-200">
                <h3 id="modalTitle" class="text-2xl font-bold text-gray-800">Ajouter un utilisateur</h3>
            </div>
            <div class="p-6">
                <form id="userForm" class="space-y-4">
                    <input type="hidden" id="userId" name="userId">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom d'utilisateur *</label>
                        <input type="text" id="userUsername" name="username" required class="input-field">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe <span id="passwordRequired">*</span></label>
                        <input type="password" id="userPassword" name="password" class="input-field" minlength="6">
                        <p id="passwordHint" class="text-xs text-gray-500 mt-1">Minimum 6 caract√®res</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">R√¥le</label>
                        <select id="userRole" name="role" class="input-field">
                            <option value="admin">Admin (tous les droits)</option>
                            <option value="medecin">M√©decin (gestion compl√®te des patients)</option>
                            <option value="assistant">Assistant (consultation uniquement)</option>
                        </select>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded">
                        <h4 class="font-medium text-gray-800 mb-3">Permissions</h4>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="checkbox" id="canManagePatients" name="can_manage_patients" class="mr-2">
                                <span class="text-sm">G√©rer les patients</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="canManageEpisodes" name="can_manage_episodes" class="mr-2">
                                <span class="text-sm">G√©rer les √©pisodes</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="canExportData" name="can_export_data" class="mr-2">
                                <span class="text-sm">Exporter des donn√©es</span>
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" id="canManageUsers" name="can_manage_users" class="mr-2">
                                <span class="text-sm">G√©rer les utilisateurs (Admin)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" onclick="hideUserModal()" class="btn btn-secondary">Annuler</button>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="/static/js/csrf.js"></script>
    <script>
        async function loadProfile() {
            try {
                const response = await fetch('/api/settings/profile');
                const data = await response.json();
                
                document.getElementById('username').value = data.username;
                
                if (data.encryption_key_exists) {
                    document.getElementById('encryptionStatus').textContent = '‚úì Actif';
                    document.getElementById('encryptionStatus').className = 'badge badge-success';
                } else {
                    document.getElementById('encryptionStatus').textContent = '‚ö†Ô∏è Absent';
                    document.getElementById('encryptionStatus').className = 'badge badge-warning';
                }
            } catch (error) {
                console.error('Erreur lors du chargement du profil:', error);
            }
        }
        
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                username: formData.get('username')
            };
            
            try {
                const response = await fetchWithCSRF('/api/settings/profile', {
                    method: 'PUT',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úì ' + result.message);
                    loadProfile();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la mise √† jour du profil');
                console.error('Erreur:', error);
            }
        });
        
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = {
                current_password: formData.get('current_password'),
                new_password: formData.get('new_password'),
                confirm_password: formData.get('confirm_password')
            };
            
            try {
                const response = await fetchWithCSRF('/api/settings/password', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úì ' + result.message);
                    e.target.reset();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors du changement de mot de passe');
                console.error('Erreur:', error);
            }
        });
        
        function backupDatabase() {
            alert('‚ÑπÔ∏è Fonctionnalit√© de sauvegarde en cours de d√©veloppement.\nVeuillez copier manuellement le fichier lithiase.db pour cr√©er une sauvegarde.');
        }
        
        function exportAllData() {
            alert('‚ÑπÔ∏è Fonctionnalit√© d\'export en cours de d√©veloppement.\nUtilisez la fonction d\'export PDF pour chaque patient individuellement.');
        }
        
        let currentUser = null;
        
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/users/current');
                currentUser = await response.json();
                
                if (currentUser.can_manage_users) {
                    document.getElementById('userManagementSection').classList.remove('hidden');
                    loadUsers();
                }
            } catch (error) {
                console.error('Erreur lors du chargement de l\'utilisateur:', error);
            }
        }
        
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = users.map(user => `
                    <div class="flex items-center justify-between p-4 bg-white rounded-lg border border-indigo-200">
                        <div class="flex-1">
                            <p class="font-medium text-gray-800">${user.username}</p>
                            <p class="text-sm text-gray-600">${getRoleLabel(user.role)}</p>
                            <div class="flex flex-wrap gap-1 mt-2">
                                ${user.can_manage_patients ? '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Patients</span>' : ''}
                                ${user.can_manage_episodes ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">√âpisodes</span>' : ''}
                                ${user.can_export_data ? '<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Export</span>' : ''}
                                ${user.can_manage_users ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded">Admin</span>' : ''}
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editUser(${user.id})" class="btn btn-info btn-sm">
                                ‚úèÔ∏è Modifier
                            </button>
                            ${user.id !== currentUser.id ? `
                                <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn btn-danger btn-sm">
                                    üóëÔ∏è Supprimer
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Erreur lors du chargement des utilisateurs:', error);
            }
        }
        
        function getRoleLabel(role) {
            const roles = {
                'admin': 'Administrateur',
                'medecin': 'M√©decin',
                'assistant': 'Assistant'
            };
            return roles[role] || role;
        }
        
        function showAddUserModal() {
            document.getElementById('modalTitle').textContent = 'Ajouter un utilisateur';
            document.getElementById('userId').value = '';
            document.getElementById('userUsername').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('userPassword').required = true;
            document.getElementById('passwordRequired').textContent = '*';
            document.getElementById('passwordHint').textContent = 'Minimum 6 caract√®res';
            document.getElementById('userRole').value = 'medecin';
            document.getElementById('canManagePatients').checked = true;
            document.getElementById('canManageEpisodes').checked = true;
            document.getElementById('canExportData').checked = true;
            document.getElementById('canManageUsers').checked = false;
            
            document.getElementById('userModal').classList.remove('hidden');
        }
        
        async function editUser(userId) {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                const user = users.find(u => u.id === userId);
                
                if (!user) return;
                
                document.getElementById('modalTitle').textContent = 'Modifier l\'utilisateur';
                document.getElementById('userId').value = user.id;
                document.getElementById('userUsername').value = user.username;
                document.getElementById('userPassword').value = '';
                document.getElementById('userPassword').required = false;
                document.getElementById('passwordRequired').textContent = '(optionnel)';
                document.getElementById('passwordHint').textContent = 'Laisser vide pour ne pas changer';
                document.getElementById('userRole').value = user.role;
                document.getElementById('canManagePatients').checked = user.can_manage_patients;
                document.getElementById('canManageEpisodes').checked = user.can_manage_episodes;
                document.getElementById('canExportData').checked = user.can_export_data;
                document.getElementById('canManageUsers').checked = user.can_manage_users;
                
                document.getElementById('userModal').classList.remove('hidden');
            } catch (error) {
                console.error('Erreur:', error);
            }
        }
        
        function hideUserModal() {
            document.getElementById('userModal').classList.add('hidden');
        }
        
        const rolePresets = {
            'admin': {
                can_manage_patients: true,
                can_manage_episodes: true,
                can_export_data: true,
                can_manage_users: true
            },
            'medecin': {
                can_manage_patients: true,
                can_manage_episodes: true,
                can_export_data: true,
                can_manage_users: false
            },
            'assistant': {
                can_manage_patients: false,
                can_manage_episodes: false,
                can_export_data: false,
                can_manage_users: false
            }
        };
        
        function applyRolePreset(role) {
            const preset = rolePresets[role] || rolePresets['medecin'];
            document.getElementById('canManagePatients').checked = preset.can_manage_patients;
            document.getElementById('canManageEpisodes').checked = preset.can_manage_episodes;
            document.getElementById('canExportData').checked = preset.can_export_data;
            document.getElementById('canManageUsers').checked = preset.can_manage_users;
        }
        
        document.getElementById('userRole').addEventListener('change', (e) => {
            applyRolePreset(e.target.value);
        });
        
        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const userId = formData.get('userId');
            const data = {
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                can_manage_patients: formData.get('can_manage_patients') === 'on',
                can_manage_episodes: formData.get('can_manage_episodes') === 'on',
                can_export_data: formData.get('can_export_data') === 'on',
                can_manage_users: formData.get('can_manage_users') === 'on'
            };
            
            if (!data.password) {
                delete data.password;
            }
            
            try {
                let response;
                if (userId) {
                    response = await fetchWithCSRF(`/api/users/${userId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                } else {
                    response = await fetchWithCSRF('/api/users', {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                }
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úì Utilisateur enregistr√© avec succ√®s');
                    hideUserModal();
                    loadUsers();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de l\'enregistrement');
                console.error('Erreur:', error);
            }
        });
        
        async function deleteUser(userId, username) {
            if (!confirm(`Voulez-vous vraiment supprimer l'utilisateur ${username} ?`)) {
                return;
            }
            
            try {
                const response = await fetchWithCSRF(`/api/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('‚úì Utilisateur supprim√© avec succ√®s');
                    loadUsers();
                } else {
                    alert('‚ùå ' + result.error);
                }
            } catch (error) {
                alert('‚ùå Erreur lors de la suppression');
                console.error('Erreur:', error);
            }
        }
        
        loadProfile();
        loadCurrentUser();
    </script>
</body>
</html>
